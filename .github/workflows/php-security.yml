name: PHP Security Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  semgrep-scan:
    name: Semgrep Security Scan (PHP + JavaScript)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/php
          p/javascript
          p/owasp-top-ten
          p/xss
          p/sql-injection
        publishSarif: true
        severity: ERROR,WARNING

  phpstan-analysis:
    name: PHPStan Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, pdo_mysql, mysqli
        coverage: none

    - name: Install Composer
      run: |
        curl -sS https://getcomposer.org/installer | php
        php composer.phar install --no-progress --no-suggest --prefer-dist --no-interaction

    - name: Install PHPStan
      run: php composer.phar require --dev phpstan/phpstan --no-interaction

    - name: Create PHPStan config
      run: |
        cat > phpstan.neon << 'EOF'
        parameters:
            level: 5
            paths:
                - .
            excludePaths:
                - vendor
                - node_modules
            checkMissingIterableValueType: false
        EOF

    - name: Run PHPStan analysis
      run: |
        vendor/bin/phpstan analyse --error-format=github --no-progress

  security-scan:
    name: Basic Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, pdo_mysql, mysqli

    - name: Check for hardcoded passwords
      run: |
        echo "ðŸ” Checking for hardcoded passwords..."
        if grep -r "password.*=" . --include="*.php" --include="*.yml" --include="*.yaml" | grep -v "getenv\|environment\|example\|placeholder\|\$_POST\|DB_PASSWORD\|root_password"; then
          echo "âŒ WARNING: Potential hardcoded passwords found"
          exit 1
        else
          echo "âœ… No hardcoded passwords found"
        fi

    - name: Check for SQL injection vulnerabilities
      run: |
        echo "ðŸ” Checking for SQL injection vulnerabilities..."
        # Allow legacy login.php for educational purposes, but flag other files
        if grep -r "mysqli_query.*\$" . --include="*.php" | grep -v "mysqli_real_escape_string\|prepared\|stmt\|bind_param" | grep -v "login.php"; then
          echo "âŒ WARNING: Potential SQL injection vulnerabilities found"
          exit 1
        else
          echo "âœ… No obvious SQL injection vulnerabilities found (educational exceptions allowed)"
        fi

    - name: Check for XSS vulnerabilities
      run: |
        echo "ðŸ” Checking for XSS vulnerabilities..."
        if grep -r "echo.*\$" . --include="*.php" | grep -v "htmlspecialchars\|htmlentities\|filter_var\|csrf\|token\|login\.php"; then
          echo "âŒ WARNING: Potential XSS vulnerabilities found"
          exit 1
        else
          echo "âœ… No obvious XSS vulnerabilities found (educational exceptions allowed)"
        fi

    - name: Check for file inclusion vulnerabilities
      run: |
        echo "ðŸ” Checking for file inclusion vulnerabilities..."
        if grep -r "include.*\$" . --include="*.php" | grep -v "basename\|realpath\|__DIR__\|require_once\|include_once"; then
          echo "âŒ WARNING: Potential file inclusion vulnerabilities found"
          exit 1
        else
          echo "âœ… No obvious file inclusion vulnerabilities found"
        fi